{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Carga Térmica {{nombreCuarto}}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="{% static 'css/m1-carga-termica.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="text-center mb-4">Carga Térmica {{nombreCuarto}}</h1>
    <form method="post">
        {% csrf_token %}

        <fieldset class="border p-3 mb-4 rounded bg-yellow">
            <legend class="fw-bold px-2">Parámetros generales</legend>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="t_amb" class="form-label">T amb [°C]</label>
                    <input type="text" name="t_amb" id="t_amb" class="form-control form-control-center" value="25">
                </div>
                <div class="col-md-6">
                    <label for="t_cam" class="form-label">T cám [°C]</label>
                    <input type="text" name="t_cam" id="t_cam" class="form-control form-control-center" value="-5">
                </div>
                <div class="col-md-6">
                    <label for="f_segur" class="form-label">Factor de seguridad [%]</label>
                    <input type="text" name="f_segur" id="f_segur" class="form-control form-control-center" value="0">
                </div>
                <div class="col-md-6">
                    <label for="aplicacion" class="form-label">Aplicación</label>
                    <input type="text" name="aplicacion" id="aplicacion" class="form-control" value="Túnel">
                </div>
                <div class="col-md-6">
                    <label for="t_control" class="form-label">Tiempo Control</label>
                    <input type="text" name="t_control" id="t_control" class="form-control form-control-center" value="0.8">
                </div>
                <div class="col-md-6">
                    <label for="t_compresor" class="form-label">Tiempo Compresor</label>
                    <input type="text" name="t_compresor" id="t_compresor" class="form-control form-control-center" value="0.8">
                </div>
            </div>
        </fieldset>

        <fieldset class="border p-3 mb-4 rounded bg-blue">
            <legend class="fw-bold px-2">Dimensiones del cuarto</legend>
            <div class="row g-3">
                <div class="col-md-6"><label for="l_m" class="form-label">L [m]</label><input type="text" name="l_m" class="form-control form-control-center" value="5.0"></div>
                <div class="col-md-6"><label for="pared" class="form-label">Pared [mm]</label><input type="text" name="pared" class="form-control form-control-center" value="100"></div>
                <div class="col-md-6"><label for="a_m" class="form-label">a [m]</label><input type="text" name="a_m" class="form-control form-control-center" value="3.0"></div>
                <div class="col-md-6"><label for="techo" class="form-label">Techo [mm]</label><input type="text" name="techo" class="form-control form-control-center" value="100"></div>
                <div class="col-md-6"><label for="h_m" class="form-label">h [m]</label><input type="text" name="h_m" class="form-control form-control-center" value="3.0"></div>
                <div class="col-md-6"><label for="piso" class="form-label">Piso [mm]</label><input type="text" name="piso" class="form-control form-control-center" value="100"></div>
            </div>
        </fieldset>

        <fieldset class="border p-3 mb-4 rounded bg-green">
            <legend class="fw-bold px-2">Producto 1</legend>
            <div class="row g-3">
                <div class="col-md-4"><label for="producto1" class="form-label">Nombre</label><input type="text" name="producto1" class="form-control" value="Salchicha de cerdo"></div>
                <div class="col-md-4"><label for="canastas1" class="form-label">Canastas [cm]</label><input type="text" name="canastas1" class="form-control form-control-center" value="25"></div>
                <div class="col-md-4"><label for="p1_t_in" class="form-label">T in [°C]</label><input type="text" name="p1_t_in" class="form-control form-control-center" value="55"></div>
                <div class="col-md-4"><label for="p1_t_cong" class="form-label">T cong [°C]</label><input type="text" name="p1_t_cong" class="form-control form-control-center" value="FALTA"></div>
                <div class="col-md-4"><label for="p1_t_out" class="form-label">T out [°C]</label><input type="text" name="p1_t_out" class="form-control form-control-center" value="4"></div>
                <div class="col-md-4"><label for="rotacion" class="form-label">Rotación</label><input type="text" name="rotacion" class="form-control form-control-center" value="1.050"></div>
                <div class="col-md-4"><label for="f_carga" class="form-label">Factor carga</label><input type="text" name="f_carga" class="form-control form-control-center" value="1.1"></div>
                <div class="col-md-4"><label for="almac" class="form-label">Almacenamiento [ton]</label><input type="text" name="Almacenamiento" class="form-control form-control-center" value="0.3"></div>
                <div class="col-md-4"><label for="calor_latente" class="form-label">Calor latente</label><input type="text" name="calor_latente" class="form-control form-control-center" value="64.0"></div>
                <div class="col-md-4"><label for="p1_c" class="form-label">C</label><input type="text" name="p1_c" class="form-control form-control-center" value="0.7"></div>
                <div class="col-md-4"><label for="p1_cp" class="form-label">Cp p cong</label><input type="text" name="p1_cp" class="form-control form-control-center" value="0.7"></div>
                
                <div id="calorEvolucionBox" class="col-md-4">
                    <label for="calor_evolucion" class="form-label">Calor evolución</label>
                    <input type="text" name="calor_evolucion" class="form-control form-control-center" value="0.0">
                </div>
            </div>
            
            <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" id="toggleCalorEvolucion" checked>
                <label class="form-check-label" for="toggleCalorEvolucion">
                    Mostrar calor evolución
                </label>
            </div>
        </fieldset>

        <fieldset class="border p-3 mb-4 rounded bg-green">
            <legend class="fw-bold px-2">Producto opcional</legend>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="toggleProducto2">
                <label class="form-check-label" for="toggleProducto2">
                    Agregar Producto 2
                </label>
            </div>
        </fieldset>

        <fieldset class="border p-3 mb-4 rounded bg-green" id="producto2" style="display: none;">
            <legend class="fw-bold px-2">Producto 2</legend>
            <div class="row g-3">
                <div class="col-md-4"><label for="producto2" class="form-label">Nombre</label><input type="text" name="producto2" class="form-control" value=""></div>
                <div class="col-md-4"><label for="canastas2" class="form-label">Canastas [cm]</label><input type="text" name="canastas2" class="form-control form-control-center" value=""></div>
                <div class="col-md-4"><label for="p2_t_in" class="form-label">T in [°C]</label><input type="text" name="p2_t_in" class="form-control form-control-center" value=""></div>
                <div class="col-md-4"><label for="p2_t_cong" class="form-label">T cong [°C]</label><input type="text" name="p2_t_cong" class="form-control form-control-center" value=""></div>
                <div class="col-md-4"><label for="p2_t_out" class="form-label">T out [°C]</label><input type="text" name="p2_t_out" class="form-control form-control-center" value=""></div>
                <div class="col-md-4"><label for="rotacion2" class="form-label">Rotación</label><input type="text" name="rotacion2" class="form-control form-control-center" value=""></div>
                <div class="col-md-4"><label for="f_carga2" class="form-label">Factor carga</label><input type="text" name="f_carga2" class="form-control form-control-center" value=""></div>
                <div class="col-md-4"><label for="almac2" class="form-label">Almacenamiento [ton]</label><input type="text" name="almac2" class="form-control form-control-center" value=""></div>
                <div class="col-md-4"><label for="calor_latente2" class="form-label">Calor latente</label><input type="text" name="calor_latente2" class="form-control form-control-center" value=""></div>
                <div class="col-md-4"><label for="p2_c" class="form-label">C</label><input type="text" name="p2_c" class="form-control form-control-center" value="0.7"></div>
                <div class="col-md-4"><label for="p2_cp" class="form-label">Cp p cong</label><input type="text" name="p2_cp" class="form-control form-control-center" value="0.7"></div>
                
                <div id="calorEvolucionBox2" class="col-md-4">
                    <label for="calor_evolucion2" class="form-label">Calor evolución</label>
                    <input type="text" name="calor_evolucion2" class="form-control form-control-center" value="">
                </div>
            </div>
            
            <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" id="toggleCalorEvolucion2" checked>
                <label class="form-check-label" for="toggleCalorEvolucion2">
                    Mostrar calor evolución
                </label>
            </div>
        </fieldset>

        <fieldset class="border p-3 mb-4 rounded bg-beige">
            <legend class="fw-bold px-2">Personas</legend>
            <div class="row g-3">
                <div class="col-md-4"><label for="personas" class="form-label">Personas</label><input type="text" name="personas" class="form-control form-control-center" value="2"></div>
                <div class="col-md-4"><label for="t_h_personas" class="form-label">Tiempo [h]</label><input type="text" name="t_h_personas" class="form-control form-control-center" value="0.5"></div>
                <div class="col-md-4"><label for="carros" class="form-label">Carros</label><input type="text" name="carros" class="form-control form-control-center" value="3"></div>
            </div>
        </fieldset>

        <fieldset class="border p-3 mb-4 rounded bg-beige">
            <legend class="fw-bold px-2">Iluminación</legend>
            <div class="row g-3">
                <div class="col-md-4"><label for="luxes" class="form-label">Luxes</label><input type="text" name="luxes" class="form-control form-control-center" value="300"></div>
                <div class="col-md-4"><label for="luminaria" class="form-label">Luminaria</label><input type="text" name="luminaria" class="form-control" value="LED 40W"></div>
                <div class="col-md-4"><label for="cantidad_luminarias" class="form-label">Cantidad</label><input type="text" name="cantidad_luminarias" class="form-control form-control-center" value="3"></div>
                <div class="col-md-4"><label for="w" class="form-label">Potencia [W]</label><input type="text" name="w" class="form-control form-control-center" value="40"></div>
                <div class="col-md-4"><label for="t_h_ilum" class="form-label">Tiempo [h]</label><input type="text" name="t_h_ilum" class="form-control form-control-center" value="0.5"></div>
            </div>
        </fieldset>

        <fieldset class="border p-3 mb-4 rounded bg-gray">
            <legend class="fw-bold px-2">Evaporadores</legend>
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="evap" class="form-label">Modelo</label>
                    <select name="evap" id="evap" class="form-select">
                        <option value="">Seleccione un modelo</option>
                        {% for evap in evaporadores_lista %}
                        <option value="{{ evap.modelo }}">{{ evap.modelo }}</option>
                        {% endfor %}
                    </select>
                </div>
        
                <div class="col-md-3"><label for="cant_evap" class="form-label">Cantidad</label><input type="text" name="cant_evap" class="form-control form-control-center"></div>
                <div class="col-md-3"><label for="n_mot" class="form-label">N° motores</label><input type="text" name="n_mot" class="form-control form-control-center" readonly></div>
                <div class="col-md-3"><label for="m3_h_c_u" class="form-label">m³/h c/u</label><input type="text" name="m3_h_c_u" class="form-control form-control-center" readonly></div>
                <div class="col-md-3"><label for="hp" class="form-label">HP</label><input type="text" name="hp" class="form-control form-control-center" readonly></div>
                <div class="col-md-3"><label for="largo_mm" class="form-label">Largo [mm]</label><input type="text" name="largo_mm" class="form-control form-control-center" readonly></div>
                <div class="col-md-3"><label for="c_h" class="form-label">Cambio/Horas</label><input type="text" name="c_h" class="form-control form-control-center"></div>
            </div>
        </fieldset>

        <fieldset class="border p-3 mb-4 rounded bg-blue">
            <legend class="fw-bold px-2">Infiltración de aire</legend>
            <div class="row g-3">
                <div class="col-md-6"><label for="tipo" class="form-label">Tipo</label><input type="text" name="tipo" class="form-control" value="por volumen"></div>
                <div class="col-md-6"><label for="factor" class="form-label">Factor</label><input type="text" name="factor" class="form-control form-control-center" value="2.0"></div>
            </div>
        </fieldset>

        <fieldset class="border p-3 mb-4 rounded bg-blue">
            <legend class="fw-bold px-2">Carga Adicionales por Maquinas</legend>
            <div class="row g-3">
                <div class="col-md-4"><label for="m1_cantidad" class="form-label">Cantidad Maquinaria 1</label><input type="text" name="m1_cantidad" class="form-control form-control-center" value="2"></div>
                <div class="col-md-4"><label for="m1_hp" class="form-label">Consumo [HP]</label><input type="text" name="m1_hp" class="form-control form-control-center" value="10"></div>
                <div class="col-md-4"><label for="m1_t" class="form-label">Horas Operacion</label><input type="text" name="m1_t" class="form-control form-control-center" value="2.0"></div>
                <div class="col-md-4"><label for="m2_cantidad" class="form-label">Cantidad Maquinaria 2</label><input type="text" name="m2_cantidad" class="form-control form-control-center" value="2"></div>
                <div class="col-md-4"><label for="m2_hp" class="form-label">Consumo [HP]</label><input type="text" name="m2_hp" class="form-control form-control-center" value="10"></div>
                <div class="col-md-4"><label for="m2_t" class="form-label">Horas Operacion</label><input type="text" name="m2_t" class="form-control form-control-center" value="2.0"></div>
            </div>
        </fieldset>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary">Enviar Información</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Lógica para mostrar/ocultar secciones basadas en checkboxes ---
    
    // Producto 2
    const toggleProducto2 = document.getElementById('toggleProducto2');
    const producto2 = document.getElementById('producto2');
    producto2.style.display = toggleProducto2.checked ? 'block' : 'none';
    toggleProducto2.addEventListener('change', function() {
        producto2.style.display = this.checked ? 'block' : 'none';
    });

    // Producto 1 - Calor Evolución
    const toggleCE = document.getElementById('toggleCalorEvolucion');
    const calorEvolucionBox = document.getElementById('calorEvolucionBox');
    calorEvolucionBox.style.display = toggleCE.checked ? 'block' : 'none';
    toggleCE.addEventListener('change', function() {
        calorEvolucionBox.style.display = this.checked ? 'block' : 'none';
    });

    // Producto 2 - Calor Evolución
    const toggleCE2 = document.getElementById('toggleCalorEvolucion2');
    const calorEvolucionBox2 = document.getElementById('calorEvolucionBox2');
    calorEvolucionBox2.style.display = toggleCE2.checked ? 'block' : 'none';
    toggleCE2.addEventListener('change', function() {
        calorEvolucionBox2.style.display = this.checked ? 'block' : 'none';
    });

    // --- Lógica del Menú Desplegable (Dropdown) ---
    
    const selectEvap = document.getElementById('evap');

    // Escucha el evento 'change' del menú desplegable.
    selectEvap.addEventListener('change', async function() {
        const modeloSeleccionado = this.value;
        if (modeloSeleccionado) {
            obtenerDatosEvaporador(modeloSeleccionado);
        } else {
            // Limpia los campos si se selecciona la opción de "Seleccione un modelo"
            limpiarCamposEvaporador();
        }
    });
    
    // Función para limpiar todos los campos del evaporador
    function limpiarCamposEvaporador() {
        document.querySelector('input[name="n_mot"]').value = '';
        document.querySelector('input[name="m3_h_c_u"]').value = '';
        document.querySelector('input[name="hp"]').value = '';
        document.querySelector('input[name="watts"]').value = '';
        document.querySelector('input[name="largo_mm"]').value = '';
        updateCalculations();
    }

    function updateCalculations() {
        // 1. OBTENER VALORES DE DIMENSIÓN
        const largo = parseFloat(document.querySelector('input[name="l_m"]').value) || 0;
        const ancho = parseFloat(document.querySelector('input[name="a_m"]').value) || 0;
        const alto = parseFloat(document.querySelector('input[name="h_m"]').value) || 0;

        // 2. OBTENER Y NORMALIZAR EL CAUDAL UNITARIO
        
        // OBTENER VALOR COMO STRING PRIMERO para poder usar .replace()
        const caudal_unitario_raw = document.querySelector('input[name="m3_h_c_u"]').value;
        
        // NORMALIZACIÓN:
        // a) Eliminar el separador de miles (asumimos que es el punto '.')
        let caudal_unitario_clean = caudal_unitario_raw.replace(/\./g, '');
        
        // b) Si el separador decimal es la coma ',', reemplazarlo por el punto '.' (formato JS/Numérico)
        // ESTE PASO SÓLO ES NECESARIO SI TIENES DECIMALES, ej: 13.940,50 -> 13940.50
        // Si tus caudales son números enteros (como 13.940), omite esta línea.
        // caudal_unitario_clean = caudal_unitario_clean.replace(/,/g, '.');

        // Convertir el valor limpio a número
        const caudal_unitario = parseFloat(caudal_unitario_clean) || 0; 
        
        // 3. OBTENER CANTIDAD
        const cantidad_evap = parseFloat(document.querySelector('input[name="cant_evap"]').value) || 0; 

        // output
        const inputCambioHora = document.querySelector('input[name="c_h"]');

        // 4. CÁLCULO
        const volumen_cuarto = largo * ancho * alto; 
        const caudal_total = caudal_unitario * cantidad_evap; 

        let cambio_por_hora = 0;

        if (volumen_cuarto > 0) {
            cambio_por_hora = caudal_total / volumen_cuarto; 
        }
        
        // 5. MOSTRAR RESULTADO
        inputCambioHora.value = cambio_por_hora.toFixed(2);
    }


    // Esta función hará la llamada AJAX para obtener los detalles del Evaporador
    async function obtenerDatosEvaporador(modelo) { 
        try {
            const response = await fetch(`/carga-termica/api/evaporador-data/?modelo=${modelo}`);
            const data = await response.json();
            
            // Llenar los campos con los datos obtenidos
            document.querySelector('input[name="n_mot"]').value = data.n_mot || ''; 
            document.querySelector('input[name="m3_h_c_u"]').value = data.m3_h_c_u || '';
            document.querySelector('input[name="hp"]').value = data.hp || ''; 
            document.querySelector('input[name="largo_mm"]').value = data.largo_mm || '';

            updateCalculations(); 
        } catch (error) {
            console.error("Error al obtener datos del evaporador:", error);
            limpiarCamposEvaporador();
        }
    }

    // Escucha los cambios en los campos de dimensiones y cantidad de evaporadores
    const inputLargo = document.querySelector('input[name="l_m"]');
    const inputAncho = document.querySelector('input[name="a_m"]');
    const inputAlto = document.querySelector('input[name="h_m"]');
    const inputCantidadEvap = document.querySelector('input[name="cant_evap"]');

    //asignar eventos de escucha para los calculos en tiempo real 
    if (inputLargo) {
        inputLargo.addEventListener('input', updateCalculations);
    }

    if (inputAncho) {
        inputAncho.addEventListener('input', updateCalculations);
    }

    if (inputAlto) {
        inputAlto.addEventListener('input', updateCalculations);
    }

    if (inputCantidadEvap) {
        inputCantidadEvap.addEventListener('input', updateCalculations);
    }

    // inicializar los cálculos al cargar la página
    updateCalculations();

});
</script>
{% endblock %}
